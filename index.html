<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP部室予約 v3.4</title>
<style>
  :root{
    --glass: rgba(255,255,255,.12);
    --card: rgba(255,255,255,.18);
    --border: rgba(255,255,255,.35);
    --text: #ffffff;
    --muted: #e5e7eb;
    --accent: #ffffff;
    --danger: #ef4444;
    --ok:#22c55e;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 18px;
    --cellW: 120px;
    --cellH: 52px;
    --headH: 56px;
    --timeW: 92px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    color: var(--text);
    background: #000;
    min-height:100dvh;
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .bg{ position:fixed; inset:0; background:url("BG.jpg") center/cover no-repeat fixed; filter:saturate(1.05) brightness(.85); z-index:-2; }
  .bg::after{ content:""; position:absolute; inset:0; backdrop-filter: blur(2px); background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.75)); }

  /* 画面切替フェード */
  #xfade{ position:fixed; inset:0; pointer-events:none; background:#000; opacity:0; transition:opacity .18s ease; z-index:25; }
  #xfade.on{ opacity:.35; }

  .center-wrap{ width:min(100%,720px); padding:28px; display:flex; flex-direction:column; align-items:center; gap:22px; }
  .title{ font-weight:800; line-height:1.1; text-align:center; color:#fff; text-shadow:0 2px 0 rgba(0,0,0,.35), 0 8px 22px rgba(0,0,0,.55); letter-spacing:.02em; }
  @media (max-width:480px){ .title{font-size: clamp(28px, 8vw, 40px);} }
  @media (min-width:481px){ .title{font-size: clamp(36px, 4.6vw, 58px);} }

  /* ホームのボタン（ログイン／閲覧のみ表示） */
  .btn-grid{
    display:grid; grid-template-columns: 1fr 1fr; gap:14px; width:100%;
    align-items:center; justify-items:center;
  }
  .btn-grid .span2{ grid-column: 1 / span 2; width:100%; }
  .btn{ -webkit-tap-highlight-color:transparent; appearance:none; border:none; cursor:pointer; padding:14px 22px; min-width:140px; font-weight:700; letter-spacing:.04em; color:#0f172a; background:#fff; border-radius:999px; box-shadow: inset 0 -2px 0 rgba(0,0,0,.12), 0 10px 20px rgba(0,0,0,.25); transform:translateY(0); transition: transform .08s ease, box-shadow .08s ease, filter .08s ease; user-select:none; }
  .btn:active{ transform:translateY(2px); box-shadow: inset 0 -0px 0 rgba(0,0,0,.08), 0 6px 12px rgba(0,0,0,.22); filter:brightness(.96); }
  .btn.ghost{ background:transparent; color:#fff; border:1px solid var(--border); box-shadow:none; }
  .btn.small{ padding:10px 14px; min-width:unset; font-weight:600 }
  .btn.wide{ width:100%; justify-self:stretch; }

  /* 右上ハンバーガー（3本線の長さを統一） */
  .hamburger{
    position:fixed; right:12px; top:12px; z-index:20;
    width:44px; height:44px; border-radius:12px; border:1px solid var(--border);
    background:rgba(0,0,0,.35); color:#fff; display:grid; place-items:center;
    box-shadow:var(--shadow); cursor:pointer;
  }
  .hamburger .stack{ display:flex; flex-direction:column; gap:4px; align-items:center; }
  .hamburger .line{
    width:22px; height:2px; background:#fff; border-radius:2px;
  }

  /* 右スライドドロワー */
  .drawer{
    position:fixed; top:0; right:-280px; width:260px; height:100dvh;
    background:rgba(10,15,25,.92); backdrop-filter: blur(10px);
    border-left:1px solid var(--border); box-shadow: -10px 0 30px rgba(0,0,0,.45);
    transition:right .2s ease; z-index:30; padding:16px;
    display:flex; flex-direction:column; gap:8px;
  }
  .drawer.open{ right:0; }
  .drawer h3{ margin:4px 0 10px; font-size:14px; opacity:.85; letter-spacing:.12em }
  .drawer-item{
    padding:12px 10px; border-radius:12px; border:1px solid var(--border);
    background:rgba(255,255,255,.06); color:#fff; cursor:pointer;
  }
  .drawer-item:active{ filter:brightness(1.1) }

  .card{ width:min(100%,720px); background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; backdrop-filter: blur(10px); }
  .card h2{ margin:6px 0 10px; font-size:20px }
  .row{ display:flex; gap:10px; margin:10px 0; align-items:center }
  .row label{ width:120px; color:var(--muted); font-size:14px }
  .row input, .row select, .row textarea{ flex:1; padding:12px 12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.9); color:#0f172a; font-size:16px; outline:none; }
  .row textarea{ min-height:100px; }
  .row input[type=password], .row input[type=text]{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:.02em }
  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }
  .hint{ font-size:12px; color:#e5e7eb; opacity:.9 }
  .error{ color:#fecaca; font-size:13px; margin-top:4px }

  .topbar{ position:fixed; left:8px; right:8px; top:8px; z-index:10; display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .topbar .left, .topbar .right{ display:flex; gap:8px; align-items:center }
  .tag{ padding:6px 10px; border-radius:999px; background:var(--glass); border:1px solid var(--border); font-size:12px }

  .grid-wrap{ position:absolute; inset:60px 8px 8px 8px; background:rgba(0,0,0,.55); border:1px solid var(--border); border-radius:var(--radius); backdrop-filter: blur(6px); overflow:auto; box-shadow:var(--shadow); }
  .schedule{ position:relative; min-width: calc(var(--timeW) + 14 * var(--cellW)); }
  .header{ position:sticky; top:0; display:grid; grid-template-columns: var(--timeW) repeat(14, var(--cellW)); height:var(--headH); z-index:2; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); border-bottom: 1px solid var(--border); }
  .header > div{ display:flex; align-items:center; justify-content:center; text-align:center; font-weight:700; font-size:13px; padding:6px; border-right:1px solid var(--border); text-shadow: 0 1px 2px rgba(0,0,0,.65); }
  .header > div.today{ background: rgba(255,255,255,.12); box-shadow: inset 0 0 0 999px rgba(255,255,255,.06); }
  .row-time{ display:grid; grid-template-columns: var(--timeW) repeat(14, var(--cellW)); }
  .cell, .timecell{ height:var(--cellH); border-right:1px solid var(--border); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:13px; text-align:center; padding:4px; }
  .cell{ color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,.9); }
  .timecell{ position:sticky; left:0; z-index:1; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); font-weight:700; text-shadow: 0 1px 2px rgba(0,0,0,.75); }
  .cell.empty{ cursor:pointer }
  .cell.mine{ outline:2px dashed rgba(255,255,255,.45); outline-offset:-3px }
  .cell.badge{ font-weight:700; }
  .legend{ display:flex; gap:10px; align-items:center; font-size:12px; opacity:.9 }
  .legend .dot{ width:10px; height:10px; border-radius:3px; background:#fff; display:inline-block; border:1px solid #fff }
  .events-row .timecell{ background: rgba(0,0,0,.65); }
  .events-row .cell{ background: rgba(0,0,0,.40); }

  dialog{ border:none; border-radius:16px; padding:18px; background:#0b1220; color:#fff; width:min(92vw, 420px); border:1px solid var(--border); box-shadow:var(--shadow); }
  dialog::backdrop{ background: rgba(0,0,0,.55) }
  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px }
  .hr{ height:1px; background:var(--border); margin:10px 0 }

  /* 管理パネルはフルスクロール可能に */
  #adminPanel{ position:fixed; inset:8px; overflow:auto; }

  @media (max-width:480px){
    :root{ --cellW: 120px; --cellH: 56px; --timeW: 86px; }
    .btn{ min-width:120px }
  }
</style>
</head>
<body>
  <div class="bg"></div>
  <div id="xfade"></div>

  <!-- 右上ハンバーガー -->
  <button class="hamburger" id="btnHamburger" aria-label="menu">
    <div class="stack">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
  </button>

  <!-- 右スライドドロワー -->
  <aside class="drawer" id="drawer">
    <h3>メニュー</h3>
    <div class="drawer-item" id="navEvents">イベント</div>
    <div class="drawer-item" id="navRules">ルール</div>
    <div class="drawer-item" id="navArchive">過去予約</div>
    <div class="drawer-item" id="navHistory">履歴</div>
    <div class="drawer-item" id="navAdmin">管理</div>
  </aside>

  <!-- ホーム（ログイン／閲覧のみ） -->
  <section id="home" class="center-wrap" hidden>
    <h1 class="title">ESP部室予約サイト</h1>
    <div class="btn-grid">
      <button class="btn wide span2" id="btnLogin">ログイン</button>
      <button class="btn wide span2" id="btnBrowse">閲覧</button>
    </div>
  </section>

  <!-- ログイン（method="dialog" をやめる：FaceID等で勝手に閉じない） -->
  <dialog id="dlgLogin">
    <form id="loginForm" autocomplete="on">
      <h2>ログイン</h2>
      <div class="row"><label>漢字フルネーム</label><input id="loginName" name="username" required placeholder="山田太郎" /></div>
      <div class="row"><label>パスワード</label><input id="loginPass" name="password" type="password" required /></div>
      <div class="hint">※ 新規登録をご希望の方は幹部までご連絡ください。</div>
      <div class="error" id="loginErr" hidden>名前またはパスワードが違います。</div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" id="btnLoginClose">閉じる</button>
        <button type="submit" class="btn">ログイン</button>
      </div>
    </form>
  </dialog>

  <!-- 管理パスワード（同上：勝手に閉じない） -->
  <dialog id="dlgAdminPwd">
    <form id="adminPwdForm" autocomplete="on">
      <h2>管理</h2>
      <div class="row"><label>パスワード</label><input id="adminPwd" type="password" required placeholder="管理パスワード" /></div>
      <div class="error" id="adminPwdErr" hidden>パスワードが違います。</div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" id="btnAdminPwdClose">閉じる</button>
        <button type="submit" class="btn">認証</button>
      </div>
    </form>
  </dialog>

  <!-- ルール -->
  <dialog id="dlgRules">
    <form method="dialog">
      <h2>予約のルール</h2>
      <div class="row"><textarea disabled style="background:rgba(255,255,255,.92); color:#0f172a">【予約のルール】
・バンド練は1日2H、個人練は1日1Hまで！
・定期ライブ2週間前は出演バンド優先！
</textarea></div>
      <div class="modal-actions"><button class="btn" value="close">閉じる</button></div>
    </form>
  </dialog>

  <!-- 管理パネル -->
  <section id="adminPanel" class="card" hidden>
    <h2>管理パネル</h2>
    <div class="btn-row" style="justify-content:flex-start; margin:6px 0 10px">
      <button class="btn small" id="btnAdminNew">新規登録</button>
      <button class="btn small" id="btnAdminList">ユーザー照会</button>
      <button class="btn small" id="btnAdminBoard">予約表管理</button>
      <button class="btn small" id="btnAdminLimits">制限</button>
      <button class="btn small ghost" id="btnAdminBack">HOME</button>
    </div>
    <!-- 新規登録 -->
    <div id="adminNew" hidden>
      <div class="row"><label>漢字フルネーム</label><input id="regName" placeholder="山田太郎" /></div>
      <div class="row"><label>パスワード</label><input id="regPass" type="password" placeholder="英数字4〜8桁" /></div>
      <div class="row"><label>パスワード再入力</label><input id="regPass2" type="password" placeholder="もう一度" /></div>
      <div class="error" id="regErr" hidden></div>
      <div class="actions"><button class="btn" id="btnDoRegister">登録</button></div>
      <div class="hint">※ 大文字小文字を区別します。半角英数字4〜8桁。</div>
    </div>
    <!-- ユーザー照会 -->
    <div id="adminList" hidden>
      <div id="userList"></div>
    </div>
    <!-- 制限設定（既存） -->
    <div id="adminLimits" hidden>
      <div class="card" style="padding:12px">
        <div class="row"><label>個人1日1時間</label>
          <label style="flex:1"><input type="checkbox" id="chkPersonalLimit"> ON/OFF</label>
        </div>
        <div class="row"><label>バンド1日2時間</label>
          <label style="flex:1"><input type="checkbox" id="chkBandLimit"> ON/OFF</label>
        </div>
        <div class="row"><label>Dr,Key以外の楽器制限</label>
          <label style="flex:1"><input type="checkbox" id="chkRestrictGtBa"> ON/OFF</label>
        </div>
        <div class="row"><label>予約表上のバンド時間制限</label>
          <select id="selBandTotalLimit">
            <option value="none">制限なし</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn ghost" id="btnLimitsBack">戻る</button>
          <button class="btn" id="btnSaveLimits">保存</button>
        </div>
        <div class="hint">※「制限なし」の場合でも、日単位の上限は上の設定に従います。</div>
        <div class="error" id="limitsErr" hidden></div>
      </div>
    </div>
  </section>

  <!-- 予約画面 -->
  <section id="booking" hidden>
    <div class="topbar">
      <div class="left">
        <button class="btn small" id="btnBackOrLogout">HOME</button>
        <span class="tag" id="who"></span>
        <span class="tag" id="modeTag"></span>
      </div>
      <div class="right">
        <div class="legend"><span class="dot"></span> 自分の予約は枠線表示／他人の予約は削除不可</div>
      </div>
    </div>
    <div class="grid-wrap"><div class="schedule" id="grid"></div></div>
  </section>

  <!-- イベントカレンダー -->
  <section id="events" class="card" hidden style="position:fixed; inset:8px; overflow:auto;">
    <div class="topbar" style="position:sticky; top:0;">
      <div class="left">
        <button class="btn small" id="btnEventsHome">HOME</button>
        <span class="tag">イベントカレンダー（誰でも入力可）</span>
      </div>
      <div class="right">
        <div class="btn-row">
          <button class="btn small" id="btnPrevMonth">◀ 前月</button>
          <button class="btn small" id="btnThisMonth">今月</button>
          <button class="btn small" id="btnNextMonth">次月 ▶</button>
        </div>
      </div>
    </div>
    <div id="calendarHead" style="font-weight:800; font-size:18px; margin:10px 0 6px; text-shadow:0 1px 2px rgba(0,0,0,.6)"></div>
    <div id="calendar" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;"></div>
    <div class="hint" style="margin-top:8px">日付をクリックしてイベント内容を入力／更新できます。複数行OK。</div>
  </section>

  <!-- 履歴 -->
  <section id="history" class="card" hidden style="position:fixed; inset:8px; overflow:auto;">
    <div class="topbar" style="position:sticky; top:0;">
      <div class="left">
        <button class="btn small" id="btnHistoryHome">HOME</button>
        <span class="tag">最新の予約履歴</span>
      </div>
    </div>
    <div id="historyList" style="margin-top:54px"></div>
  </section>

  <!-- 過去予約（2週間分・閲覧専用） -->
  <section id="archive" hidden>
    <div class="topbar">
      <div class="left">
        <button class="btn small" id="btnArchiveHome">HOME</button>
        <span class="tag">過去2週間の予約表（22:00時点スナップショット）</span>
      </div>
    </div>
    <div class="grid-wrap"><div class="schedule" id="archiveGrid"></div></div>
  </section>

  <!-- 予約方式選択 -->
  <dialog id="dlgChoose">
    <form method="dialog">
      <h2>予約方式</h2>
      <div class="btn-row" style="margin:8px 0 6px">
        <button class="btn" value="personal">個人</button>
        <button class="btn" value="band">バンド</button>
      </div>
      <div class="modal-actions"><button class="btn ghost" formnovalidate value="close">閉じる</button></div>
    </form>
  </dialog>

  <!-- 個人：楽器選択 -->
  <dialog id="dlgPersonal">
    <form method="dialog" id="personalForm">
      <h2>個人練：楽器を選択</h2>
      <div class="row" style="display:block">
        <label style="display:block; margin-bottom:8px">楽器</label>
        <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px">
          <label><input type="radio" name="inst" value="Dr"> ドラム</label>
          <label><input type="radio" name="inst" value="Gt"> ギター</label>
          <label><input type="radio" name="inst" value="Ba"> ベース</label>
          <label><input type="radio" name="inst" value="Key"> キーボード</label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" formnovalidate value="close">閉じる</button>
        <button class="btn" id="btnPersonalConfirm" value="ok" disabled>予約確定</button>
      </div>
    </form>
  </dialog>

  <!-- バンド詳細 -->
  <dialog id="dlgBand">
    <form method="dialog" id="bandForm">
      <h2>バンド予約</h2>
      <div class="row"><label>バンド名</label><input id="bandName" required placeholder="例）ESP Combo" /></div>
      <div class="row"><label>時間</label><select id="bandDur"><option value="1">1時間</option><option value="2">2時間</option></select></div>
      <div class="error" id="bandErr" hidden></div>
      <div class="modal-actions"><button class="btn ghost" formnovalidate value="close">閉じる</button><button class="btn" value="ok">予約する</button></div>
    </form>
  </dialog>

  <!-- イベント入力 -->
  <dialog id="dlgEvent">
    <form method="dialog" id="eventForm">
      <h2 id="eventDateLabel">イベント</h2>
      <div class="row"><label>内容</label><textarea id="eventText" placeholder="テキストを入力（複数行可）"></textarea></div>
      <div class="modal-actions"><button class="btn ghost" formnovalidate value="close">閉じる</button><button class="btn" value="ok">保存</button></div>
    </form>
  </dialog>

  <!-- 削除確認 -->
  <dialog id="dlgDelete">
    <form method="dialog">
      <h2>削除しますか？</h2>
      <div class="modal-actions"><button class="btn ghost" formnovalidate value="close">閉じる</button><button class="btn" value="ok">OK</button></div>
    </form>
  </dialog>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Supabase 接続設定 =====
const SUPABASE_URL = "https://qfwkcnkgozipyuhgrieh.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmd2tjbmtnb3ppcHl1aGdyaWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTQ3MDUsImV4cCI6MjA3NjAzMDcwNX0.zVZOhDPyysOvjNaQs8ZUViKRqALd4zkU2C7169a5P5Q";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ===== ユーティリティ =====
const dayNames = ["日","月","火","水","木","金","土"];
function pad(n){ return n<10?"0"+n:""+n }
function dateToLocalISO(d){ const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate()); return `${y}-${m}-${da}`; }
function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); d.setHours(0,0,0,0); return d; }
function randomPastel(){ const h=Math.floor(Math.random()*360), s=55+Math.floor(Math.random()*20), l=78+Math.floor(Math.random()*8); return `hsl(${h} ${s}% ${l}%)`; }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

// ===== 設定（制限） =====
let appSettings = {
  personalDailyLimitOn: true,
  bandDailyLimitOn: true,
  restrictGtBa: false,
  bandTotalHoursLimit: null // null=制限なし, 数字=上限
};
async function loadSettings(){
  try{
    const { data, error } = await sb.from('settings').select('key,value').in('key',[
      'personalDailyLimitOn','bandDailyLimitOn','restrictGtBa','bandTotalHoursLimit'
    ]);
    if(error || !data) return;
    for(const r of data){
      if(r.key==='bandTotalHoursLimit'){
        appSettings.bandTotalHoursLimit = (r.value===null || r.value==='none') ? null : Number(r.value);
      }else{
        appSettings[r.key] = (r.value==='true' || r.value===true);
      }
    }
  }catch(_){}
}
async function saveSettings(){
  const rows = [
    { key:'personalDailyLimitOn', value:String(appSettings.personalDailyLimitOn) },
    { key:'bandDailyLimitOn',     value:String(appSettings.bandDailyLimitOn) },
    { key:'restrictGtBa',        value:String(appSettings.restrictGtBa) },
    { key:'bandTotalHoursLimit', value:(appSettings.bandTotalHoursLimit==null?'none':String(appSettings.bandTotalHoursLimit)) }
  ];
  const { error } = await sb.from('settings').upsert(rows, { onConflict: 'key' });
  if(error) throw new Error(error.message);
}

// ===== スナップショット（22:00保存／過去2週間表示） =====
const SNAPSHOT_HOUR = 22; // 22:00
async function ensureSnapshotFor(iso){
  // 既にある？
  const { data:exist } = await sb.from('snapshots').select('d').eq('d', iso).maybeSingle();
  if(exist) return;
  // その日の全予約を取得
  const { data, error } = await sb.from('bookings').select('*').eq('d', iso);
  if(error) return;
  // 14スロット分を詰める
  const slots = Array.from({length:12}, (_,i)=>null); // 9-21 → 12コマ
  data.forEach(r=>{
    slots[r.slot] = { type:r.type, label:r.label, color:r.color, by:r.owner, dur:r.dur };
  });
  await sb.from('snapshots').upsert({ d: iso, data: slots }, { onConflict:'d' });
}

function shouldTakeSnapshotNow(){
  const now = new Date();
  return now.getHours() >= SNAPSHOT_HOUR;
}

async function snapshotWatcherTick(){
  const todayIso = dateToLocalISO(new Date());
  if(shouldTakeSnapshotNow()){
    await ensureSnapshotFor(todayIso);
  }
}

async function openArchive(){
  setView('archive');
  // 未保存なら当日分を補完
  await snapshotWatcherTick();
  // 2週間分ロード
  const end = new Date(); end.setHours(0,0,0,0);
  const start = addDays(end, -13);
  const startISO = dateToLocalISO(start);
  const endISO   = dateToLocalISO(end);
  const { data } = await sb.from('snapshots').select('*').gte('d', startISO).lte('d', endISO).order('d');
  // 不足日があれば（過去日でも）一応補完トライ
  const needMap = new Map();
  for(let i=0;i<14;i++){ needMap.set(dateToLocalISO(addDays(start,i)), true); }
  if(data){ for(const r of data){ needMap.delete(r.d); } }
  for(const iso of needMap.keys()){
    // 22:00以降で未保存のときのみ補完（当時の状態を完全再現はできないが、残っていれば残存データで）
    await ensureSnapshotFor(iso);
  }
  // 再取得
  const { data:rows } = await sb.from('snapshots').select('*').gte('d', startISO).lte('d', endISO).order('d');
  renderArchiveGrid(rows || []);
}

// ===== 状態 =====
let state = {
  view: "home",              // home | booking | admin | events | history | archive
  currentUser: null,          // {name}
  mode: "view",               // view | edit | admin
  adminOverride: false,       // 予約表管理からの開放フラグ
  pending: null,              // {date, slot}
  today: new Date(),
  days: [],                   // 14 days from today
  times: [],                  // 9-21 hourly
  bookings: {},               // { dateISO: { slotIdx: {...} } }
  events: {},                 // { dateISO: text }
  calMonth: null              // {y, m}
};

// ===== 画面スイッチ（フェード） =====
const xfade = document.getElementById('xfade');
function setView(v){
  xfade.classList.add('on');
  setTimeout(()=>{
    state.view = v;
    document.getElementById("home").hidden = v!=="home";
    document.getElementById("booking").hidden = v!=="booking";
    document.getElementById("adminPanel").hidden = v!=="admin";
    document.getElementById("events").hidden = v!=="events";
    document.getElementById("history").hidden = v!=="history";
    document.getElementById("archive").hidden = v!=="archive";
    setTimeout(()=> xfade.classList.remove('on'), 120);
  }, 120);
}

// ===== ハンバーガー／ドロワー =====
const btnHamburger = document.getElementById('btnHamburger');
const drawer = document.getElementById('drawer');
btnHamburger.addEventListener('click', ()=> drawer.classList.toggle('open'));
document.addEventListener('click', (e)=>{
  if(!drawer.contains(e.target) && !btnHamburger.contains(e.target)){
    drawer.classList.remove('open');
  }
});
document.getElementById('navEvents').addEventListener('click', ()=>{ drawer.classList.remove('open'); openEvents(); });
document.getElementById('navRules').addEventListener('click', ()=>{ drawer.classList.remove('open'); dlgRules.showModal(); });
document.getElementById('navArchive').addEventListener('click', ()=>{ drawer.classList.remove('open'); openArchive(); });
document.getElementById('navHistory').addEventListener('click', ()=>{ drawer.classList.remove('open'); openHistory(); });
document.getElementById('navAdmin').addEventListener('click', ()=>{ drawer.classList.remove('open'); document.getElementById("adminPwdErr").hidden=true; document.getElementById("adminPwd").value=""; dlgAdminPwd.showModal(); });

// ===== ホーム =====
const btnLogin = document.getElementById("btnLogin");
const btnBrowse = document.getElementById("btnBrowse");
const dlgLogin = document.getElementById("dlgLogin");
const dlgAdminPwd = document.getElementById("dlgAdminPwd");
const dlgRules = document.getElementById("dlgRules");
const loginForm = document.getElementById("loginForm");
const adminPwdForm = document.getElementById("adminPwdForm");

btnLogin.addEventListener("click", ()=>{ document.getElementById("loginErr").hidden=true; dlgLogin.showModal(); });
document.getElementById('btnLoginClose').addEventListener('click', ()=> dlgLogin.close());
btnBrowse.addEventListener("click", ()=>{ state.currentUser=null; state.mode="view"; state.adminOverride=false; goBooking(); });

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault(); // ★オートフィルでも勝手に閉じない
  const name = document.getElementById("loginName").value.trim();
  const pass = document.getElementById("loginPass").value;
  const { data, error } = await sb.from('app_users').select('name, pass').eq('name', name).eq('pass', pass).maybeSingle();
  if(error || !data){ document.getElementById("loginErr").hidden=false; return; }
  dlgLogin.close(); state.currentUser={name:data.name}; state.mode="edit"; state.adminOverride=false; goBooking();
});

document.getElementById('btnAdminPwdClose').addEventListener('click', ()=> dlgAdminPwd.close());
adminPwdForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  const pw = document.getElementById("adminPwd").value;
  if(pw!=="Dynagonazki1012"){ document.getElementById("adminPwdErr").hidden=false; return; }
  dlgAdminPwd.close(); openAdmin();
});

// ===== 管理 =====
const btnAdminNew = document.getElementById("btnAdminNew");
const btnAdminList = document.getElementById("btnAdminList");
const btnAdminBack = document.getElementById("btnAdminBack");
const btnAdminBoard = document.getElementById("btnAdminBoard");
const btnAdminLimits = document.getElementById("btnAdminLimits");
const adminNew = document.getElementById("adminNew");
const adminList = document.getElementById("adminList");
const adminLimits = document.getElementById("adminLimits");
const userList = document.getElementById("userList");
const regErr = document.getElementById("regErr");

btnAdminNew.addEventListener("click", ()=> showAdminTab("new"));
btnAdminList.addEventListener("click", ()=> showAdminTab("list"));
btnAdminLimits.addEventListener("click", ()=> showAdminTab("limits"));
btnAdminBack.addEventListener("click", ()=> { state.currentUser=null; state.adminOverride=false; setView("home"); });
btnAdminBoard.addEventListener("click", ()=> { state.mode = "admin"; state.adminOverride=true; state.currentUser = {name:"[管理]"}; goBooking(); });

function openAdmin(){ setView("admin"); showAdminTab("new"); renderUserList(); }
function showAdminTab(which){
  adminNew.hidden   = which!=="new";
  adminList.hidden  = which!=="list";
  adminLimits.hidden= which!=="limits";
  if(which==="limits") initLimitsView();
}

document.getElementById("btnDoRegister").addEventListener("click", async ()=>{
  const name = document.getElementById("regName").value.trim();
  const pass = document.getElementById("regPass").value;
  const pass2= document.getElementById("regPass2").value;
  regErr.hidden=true; regErr.textContent="";
  const err=(m)=>{ regErr.textContent=m; regErr.hidden=false; };
  if(!name) return err("名前を入力してください");
  if(!/^[A-Za-z0-9]{4,8}$/.test(pass)) return err("パスワードは半角英数字4〜8桁です");
  if(pass!==pass2) return err("パスワードが一致しません");
  const { data:exists } = await sb.from('app_users').select('name').eq('name', name).maybeSingle();
  if(exists) return err("同じ名前のユーザーがすでに存在します");
  const { error } = await sb.from('app_users').insert([{ name, pass }]);
  if(error) return err("登録に失敗しました: "+error.message);
  document.getElementById("regName").value = "";
  document.getElementById("regPass").value = "";
  document.getElementById("regPass2").value = "";
  await renderUserList(); showAdminTab("list");
});

async function renderUserList(){
  const { data, error } = await sb.from('app_users').select('name, pass').order('name');
  if(error){ userList.innerHTML = `<div class="hint">読み込みエラー: ${escapeHTML(error.message)}</div>`; return; }
  if(!data || data.length===0){ userList.innerHTML = `<div class="hint">ユーザーはまだ登録されていません。</div>`; return; }
  userList.innerHTML = data.map((u)=>`
    <div class="card" style="padding:10px; margin:8px 0">
      <div class="row" style="margin:6px 0"><label>名前</label><input value="${escapeHTML(u.name)}" disabled /></div>
      <div class="row" style="margin:6px 0"><label>パスワード</label><input value="${escapeHTML(u.pass)}" disabled /></div>
      <div class="actions"><button class="btn small" onclick="deleteUser('${encodeURIComponent(u.name)}')">削除</button></div>
    </div>`).join("");
}

window.deleteUser = async function(nameEnc){
  const name = decodeURIComponent(nameEnc);
  if(!confirm(`ユーザー「${name}」を削除しますか？`)) return;
  await sb.from('bookings').delete().eq('owner', name);
  await sb.from('app_users').delete().eq('name', name);
  await renderUserList();
};

// 制限タブ 初期化＆保存
const chkPersonalLimit = document.getElementById('chkPersonalLimit');
const chkBandLimit = document.getElementById('chkBandLimit');
const chkRestrictGtBa = document.getElementById('chkRestrictGtBa');
const selBandTotalLimit = document.getElementById('selBandTotalLimit');
const btnSaveLimits = document.getElementById('btnSaveLimits');
const btnLimitsBack = document.getElementById('btnLimitsBack');
const limitsErr = document.getElementById('limitsErr');

function initLimitOptions(){
  if(selBandTotalLimit.options.length<=1){
    for(let i=1;i<=27;i++){
      const o=document.createElement('option'); o.value=String(i); o.textContent=`${i}時間`;
      selBandTotalLimit.appendChild(o);
    }
  }
}
async function initLimitsView(){
  limitsErr.hidden=true; limitsErr.textContent="";
  initLimitOptions();
  await loadSettings();
  chkPersonalLimit.checked = appSettings.personalDailyLimitOn;
  chkBandLimit.checked     = appSettings.bandDailyLimitOn;
  chkRestrictGtBa.checked  = appSettings.restrictGtBa;
  selBandTotalLimit.value  = (appSettings.bandTotalHoursLimit==null)?'none':String(appSettings.bandTotalHoursLimit);
}
btnLimitsBack.addEventListener('click', ()=> showAdminTab('new'));
btnSaveLimits.addEventListener('click', async ()=>{
  try{
    appSettings.personalDailyLimitOn = chkPersonalLimit.checked;
    appSettings.bandDailyLimitOn     = chkBandLimit.checked;
    appSettings.restrictGtBa         = chkRestrictGtBa.checked;
    appSettings.bandTotalHoursLimit  = (selBandTotalLimit.value==='none')? null : Number(selBandTotalLimit.value);
    await saveSettings();
    showAdminTab('new');
  }catch(e){
    limitsErr.textContent = '保存に失敗しました：'+e.message;
    limitsErr.hidden=false;
  }
});

// ===== 予約画面 =====
const who = document.getElementById("who");
const modeTag = document.getElementById("modeTag");
const btnBackOrLogout = document.getElementById("btnBackOrLogout");
const grid = document.getElementById("grid");
const dlgChoose = document.getElementById("dlgChoose");
const dlgPersonal = document.getElementById("dlgPersonal");
const personalForm = document.getElementById("personalForm");
const btnPersonalConfirm = document.getElementById("btnPersonalConfirm");
const dlgBand = document.getElementById("dlgBand");
const bandForm = document.getElementById("bandForm");
const bandErr = document.getElementById("bandErr");
const dlgDelete = document.getElementById("dlgDelete");

btnBackOrLogout.addEventListener("click", ()=>{ state.currentUser=null; state.adminOverride=false; setView("home"); });

async function goBooking(){
  await loadSettings();
  setView("booking");
  who.textContent = state.currentUser ? `${state.currentUser.name}` : "閲覧";
  if(state.mode==="view"){ modeTag.textContent = "閲覧のみ"; modeTag.hidden=false; }
  else if(state.mode==="admin"){ modeTag.textContent = "管理開放"; modeTag.hidden=false; }
  else { modeTag.textContent = ""; modeTag.hidden=true; }

  buildCalendar();
  startMidnightWatcher();
  subscribeRealtime();
}

function buildCalendar(){
  state.times = []; for(let h=9; h<21; h++){ state.times.push(`${h}:00 - ${h+1}:00`); }
  state.today = new Date(); state.today.setHours(0,0,0,0);
  state.days = []; for(let i=0;i<14;i++){ state.days.push(addDays(state.today, i)); }
  Promise.all([loadBookingsRange(), loadEventsRange()]).then(([bmap, emap])=>{ state.bookings = bmap; state.events=emap; renderGrid(); });
}

async function loadBookingsRange(){
  const startISO = dateToLocalISO(state.days[0]);
  const endISO = dateToLocalISO(state.days[state.days.length-1]);
  const { data, error } = await sb.from('bookings').select('*').gte('d', startISO).lte('d', endISO);
  if(error){ console.error(error); return {}; }
  const map={}; for(const r of data){ map[r.d] = map[r.d] || {}; map[r.d][r.slot] = { by:r.owner, type:r.type, label:r.label, color:r.color, dur:r.dur }; }
  return map;
}

async function loadEventsRange(){
  const startISO = dateToLocalISO(state.days[0]);
  const endISO = dateToLocalISO(state.days[state.days.length-1]);
  const { data, error } = await sb.from('events').select('*').gte('d', startISO).lte('d', endISO);
  if(error){ console.warn('events load', error.message); return {}; }
  const map={}; for(const r of data){ map[r.d]=r.text||""; } return map;
}

// 楽観更新用の共通再描画
async function refreshBookings(){
  const map = await loadBookingsRange();
  state.bookings = map;
  renderGrid();
}

function isPast(iso){ const d=new Date(iso); return d < state.today; }
function canEdit(iso){ return state.adminOverride || !isPast(iso); }

function renderGrid(){
  grid.innerHTML = "";
  // ヘッダ
  const head = document.createElement("div"); head.className = "header";
  const timeHead = document.createElement("div"); timeHead.textContent = "時間"; head.appendChild(timeHead);
  const todayStr = dateToLocalISO(state.today);
  state.days.forEach(d=>{
    const ds = dateToLocalISO(d);
    const dv = document.createElement("div"); dv.className = (ds===todayStr)?"today":"";
    const mdColor = d.getDay()===0 ? '#ef4444' : (d.getDay()===6 ? '#3b82f6' : '#ffffff');
    const md = `${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]})`;
    dv.innerHTML = `<div><div class="date-title" style="font-size:12px;opacity:.95;color:${mdColor}">${md}</div><div style="font-size:10px;opacity:.7">${ds}</div></div>`;
    head.appendChild(dv);
  });
  grid.appendChild(head);

  // 時間行（9-21）
  for(let r=0; r<state.times.length; r++){
    const row = document.createElement("div"); row.className = "row-time";
    const tcell = document.createElement("div"); tcell.className = "timecell"; tcell.textContent = state.times[r]; row.appendChild(tcell);
    for(let c=0; c<state.days.length; c++){
      const dISO = dateToLocalISO(state.days[c]);
      const cell = document.createElement("div"); cell.className = "cell"; cell.dataset.date=dISO; cell.dataset.slot=r;
      const slotObj = state.bookings[dISO]?.[r];
      if(slotObj){
        cell.style.background = slotObj.color || "rgba(255,255,255,.08)";
        // バンド予約は黒文字
        if(slotObj.type==='band'){ cell.style.color = '#000'; cell.style.textShadow='0 1px 1px rgba(255,255,255,.25)'; }
        cell.innerHTML = `<div class="badge">${escapeHTML(slotObj.label)}</div>`;
        if(state.adminOverride){ cell.addEventListener("click", ()=> onCellAdminClick(dISO, r)); }
        else if(state.currentUser && slotObj.by === state.currentUser.name){
          if(canEdit(dISO)) { cell.classList.add("mine"); cell.addEventListener("click", ()=> onCellMineClick(dISO, r)); }
        }
      }else{
        if(state.mode!=="view" && canEdit(dISO)){
          cell.classList.add("empty");
          cell.addEventListener("click", ()=> onEmptyCellClick(dISO, r));
        } else {
          cell.style.cursor = "default";
        }
      }
      row.appendChild(cell);
    }
    grid.appendChild(row);
  }

  // イベント行
  const erow = document.createElement("div"); erow.className = "row-time events-row";
  const etime = document.createElement("div"); etime.className = "timecell"; etime.textContent = "イベント"; erow.appendChild(etime);
  for(let c=0; c<state.days.length; c++){
    const dISO = dateToLocalISO(state.days[c]);
    const cell = document.createElement("div"); cell.className = "cell"; cell.dataset.date = dISO; cell.style.opacity=.95;
    const txt = state.events[dISO] || "";
    cell.innerHTML = `<div class="badge" style="white-space:pre-wrap; line-height:1.2">${escapeHTML(txt)}</div>`;
    erow.appendChild(cell);
  }
  grid.appendChild(erow);
}

function onEmptyCellClick(date, slot){ state.pending={date, slot}; dlgChoose.returnValue=""; dlgChoose.showModal(); dlgChoose.addEventListener("close", ()=>{ const v=dlgChoose.returnValue; if(v==="personal") openPersonalDialog(); else if(v==="band") openBandDialog(); }, {once:true}); }

function openPersonalDialog(){
  btnPersonalConfirm.disabled = true;
  [...personalForm.querySelectorAll('input[name="inst"]')].forEach(r=> r.checked=false);
  dlgPersonal.returnValue=""; dlgPersonal.showModal();
  personalForm.addEventListener('change', ()=>{
    const val = personalForm.querySelector('input[name="inst"]:checked');
    btnPersonalConfirm.disabled = !val;
  });
  personalForm.addEventListener('submit', async (e)=>{
    const ret = e.submitter?.value; if(ret!=="ok") return; e.preventDefault();
    const picked = personalForm.querySelector('input[name="inst"]:checked')?.value;
    if(!picked){ return; }
    await doPersonal(picked);
  }, {once:true});
}

async function doPersonal(instAbbr){
  const name = state.currentUser?.name || "匿名";
  if(appSettings.restrictGtBa && (instAbbr==='Gt' || instAbbr==='Ba')){
    alert("現在、ギター／ベースの個人予約は制限中です。");
    return;
  }
  if(appSettings.personalDailyLimitOn && !state.adminOverride){
    const used = await countMyHours(state.pending.date, name, 'personal');
    if(used>=1){ alert("個人予約は1日1時間までです。"); return; }
  }
  const label = `${name} ${instAbbr}`;
  try{
    await insertBooking({ d:state.pending.date, slot:state.pending.slot, type:'personal', label, color:'rgba(255,255,255,.10)', dur:1, owner:name });
    if(dlgPersonal.open) dlgPersonal.close(); if(dlgChoose.open) dlgChoose.close();
    await refreshBookings();
  }catch(e){ alert(e.message); }
}

function openBandDialog(){
  bandErr.hidden=true; bandErr.textContent="";
  document.getElementById("bandName").value="";
  document.getElementById("bandDur").value="1";
  dlgBand.returnValue=""; dlgBand.showModal();
  bandForm.addEventListener("submit", (e)=>{
    const ret=e.submitter?.value; if(ret!=="ok") return;
    e.preventDefault();
    const label=document.getElementById("bandName").value.trim();
    const dur=parseInt(document.getElementById("bandDur").value,10);
    if(!label){ bandErr.textContent="バンド名を入力してください"; bandErr.hidden=false; return; }
    doBand(label,dur);
  }, {once:true});
}

async function sumBandHours(label){
  const { data, error } = await sb.from('bookings').select('dur').eq('type','band').eq('label', label);
  if(error || !data) return 0;
  return data.reduce((s,r)=> s + (r.dur>0 ? r.dur : 0), 0);
}

async function doBand(label, dur){
  const name = state.currentUser?.name || "匿名";
  const date = state.pending.date; const slot = state.pending.slot;

  if(appSettings.bandDailyLimitOn && !state.adminOverride){
    const used = await countMyHours(date, name, 'band');
    if(used>=2){ alert("バンド予約は1日2時間までです。"); return; }
  }
  const addHours = (dur===2)?2:1;
  if(appSettings.bandTotalHoursLimit!=null && !state.adminOverride){
    const total = await sumBandHours(label);
    if(total + addHours > appSettings.bandTotalHoursLimit){
      alert(`このバンドの合計時間が上限（${appSettings.bandTotalHoursLimit}時間）を超えます。`);
      return;
    }
  }

  const color = randomPastel();
  try{
    if(dur===2){
      if(slot>=state.times.length-1){ alert("2時間ブロックは最終枠では予約できません。"); return; }
      const occupied = await isOccupied(date, slot) || await isOccupied(date, slot+1);
      if(occupied && !state.adminOverride){ alert("連続2枠のどちらかが埋まっています。"); return; }
      if(occupied && state.adminOverride){
        await sb.from('bookings').delete().eq('d', date).in('slot', [slot, slot+1]);
      }
      await insertBooking({ d:date, slot:slot,   type:'band', label, color, dur:2, owner:name });
      await insertBooking({ d:date, slot:slot+1, type:'band', label, color, dur:0, owner:name });
    }else{
      const occupied = await isOccupied(date, slot);
      if(occupied && !state.adminOverride){ alert("その枠は埋まっています。"); return; }
      if(occupied && state.adminOverride){ await sb.from('bookings').delete().eq('d', date).eq('slot', slot); }
      await insertBooking({ d:date, slot:slot, type:'band', label, color, dur:1, owner:name });
    }
    if(dlgBand.open) dlgBand.close(); if(dlgChoose.open) dlgChoose.close();
    await refreshBookings();
  }catch(e){ alert(e.message); }
}

async function onCellMineClick(date, slot){
  if(!canEdit(date)) return;
  state.pending={date,slot}; dlgDelete.returnValue=""; dlgDelete.showModal();
  dlgDelete.addEventListener("close", async ()=>{
    if(dlgDelete.returnValue!=="ok") return;
    const cell = state.bookings[date]?.[slot]; if(!cell) return;
    const owner = state.currentUser?.name; if(!owner) return;
    await deleteCascade(date, slot, owner);
    await refreshBookings();
  }, {once:true});
}

async function onCellAdminClick(date, slot){
  state.pending={date,slot}; dlgDelete.returnValue=""; dlgDelete.showModal();
  dlgDelete.addEventListener("close", async ()=>{
    if(dlgDelete.returnValue!=="ok") return;
    const cell = state.bookings[date]?.[slot]; if(!cell){ return; }
    if(cell.dur===2){ await sb.from('bookings').delete().eq('d', date).in('slot', [slot, slot+1]); }
    else if(cell.dur===0){ await sb.from('bookings').delete().eq('d', date).in('slot', [slot-1, slot]); }
    else { await sb.from('bookings').delete().eq('d', date).eq('slot', slot); }
    await refreshBookings();
  }, {once:true});
}

async function deleteCascade(date, slot, owner){
  const cell = state.bookings[date]?.[slot]; if(!cell) return;
  if(cell.dur===2){ await deleteBooking({d:date, slot, owner}); if(state.bookings[date]?.[slot+1]?.by===owner){ await deleteBooking({d:date, slot:slot+1, owner}); } }
  else if(cell.dur===0){ if(state.bookings[date]?.[slot-1]?.by===owner && state.bookings[date]?.[slot-1]?.dur===2){ await deleteBooking({d:date, slot:slot-1, owner}); } await deleteBooking({d:date, slot, owner}); }
  else{ await deleteBooking({d:date, slot, owner}); }
}

// ===== Supabase I/O =====
async function insertBooking({d, slot, type, label, color, dur, owner}){ const { error } = await sb.from('bookings').insert([{ d, slot, type, label, color, dur, owner }]); if(error) throw new Error("予約に失敗: "+error.message); }
async function deleteBooking({d, slot, owner}){ const { error } = await sb.from('bookings').delete().eq('d', d).eq('slot', slot).eq('owner', owner); if(error) throw new Error("削除に失敗: "+error.message); }
async function countMyHours(d, owner, type){ const { data, error } = await sb.from('bookings').select('dur').eq('d', d).eq('owner', owner).eq('type', type); if(error) return 0; return data.reduce((s,r)=> s + (r.dur||1), 0); }
async function isOccupied(d, slot){ const { data } = await sb.from('bookings').select('id').eq('d', d).eq('slot', slot).limit(1).maybeSingle(); return !!data; }

// ===== Realtime =====
let realtimeSub = null;
function subscribeRealtime(){
  if(realtimeSub){ try{ sb.removeChannel(realtimeSub); }catch(_){} realtimeSub=null; }
  realtimeSub = sb.channel('esp-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'bookings' }, async ()=>{
      const map = await loadBookingsRange(); state.bookings = map; renderGrid();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, async ()=>{
      const emap = await loadEventsRange(); state.events = emap; renderGrid();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, async ()=>{
      await loadSettings();
    })
    .subscribe((status)=>{
      if(status==='CHANNEL_ERROR' || status==='TIMED_OUT'){
        try{ sb.removeChannel(realtimeSub); }catch(_){}
        setTimeout(subscribeRealtime, 800);
      }
    });
}

// ===== 0時の自動切替＆22:00スナップショット監視 =====
let midnightTimer=null;
function startMidnightWatcher(){
  if(midnightTimer) clearInterval(midnightTimer);
  midnightTimer = setInterval(async ()=>{
    const now=new Date(); now.setHours(0,0,0,0);
    if(now.getTime()!==state.today.getTime()){ buildCalendar(); }
    await snapshotWatcherTick(); // 22:00を跨いだら保存
  }, 60000); // 1分毎
}

// ===== イベントカレンダー =====
const calendarEl = document.getElementById('calendar');
const calendarHead = document.getElementById('calendarHead');
const dlgEvent = document.getElementById('dlgEvent');
const eventForm = document.getElementById('eventForm');
const eventTextEl = document.getElementById('eventText');
const eventDateLabel = document.getElementById('eventDateLabel');

function openEvents(){
  setView('events');
  const today = new Date();
  state.calMonth = { y: today.getFullYear(), m: today.getMonth() }; // 0-based
  renderCalendar();
}

function renderCalendar(){
  const y = state.calMonth.y, m = state.calMonth.m;
  const first = new Date(y, m, 1); const firstDow = first.getDay();
  const last = new Date(y, m+1, 0); const daysInMonth = last.getDate();
  calendarHead.textContent = `${y}年 ${m+1}月`;
  calendarEl.innerHTML = '';

  const wnames = ['日','月','火','水','木','金','土'];
  for(const w of wnames){ const h=document.createElement('div'); h.textContent=w; h.style.textAlign='center'; h.style.opacity=.9; h.style.fontWeight='700'; h.style.textShadow='0 1px 2px rgba(0,0,0,.6)'; calendarEl.appendChild(h); }

  const cells = firstDow + daysInMonth; const total = Math.ceil(cells/7)*7;
  for(let i=0;i<total;i++){
    const cell = document.createElement('div'); cell.style.minHeight='80px'; cell.style.padding='8px'; cell.style.border='1px solid var(--border)'; cell.style.borderRadius='12px'; cell.style.background='var(--glass)'; cell.style.backdropFilter='blur(6px)'; cell.style.boxShadow='var(--shadow)'; cell.style.whiteSpace='pre-wrap'; cell.style.textShadow='0 1px 2px rgba(0,0,0,.7)';
    const day = i - firstDow + 1;
    if(day>=1 && day<=daysInMonth){
      const d = new Date(y, m, day); const iso = dateToLocalISO(d);
      const title = document.createElement('div'); title.textContent = `${day}`; title.style.fontWeight='800'; title.style.marginBottom='6px';
      const body = document.createElement('div'); body.style.fontSize='12px'; body.style.opacity=.95; body.textContent = state.events[iso] || '';
      if(d.getDay()===0){ title.style.color = '#ef4444'; }
      if(d.getDay()===6){ title.style.color = '#3b82f6'; }
      cell.appendChild(title); cell.appendChild(body);
      cell.addEventListener('click', async ()=>{
        eventDateLabel.textContent = `イベント：${iso}`;
        const { data } = await sb.from('events').select('text').eq('d', iso).maybeSingle();
        eventTextEl.value = data?.text || '';
        dlgEvent.returnValue=''; dlgEvent.showModal();
        eventForm.addEventListener('submit', async (e)=>{
          const ret = e.submitter?.value; if(ret!=="ok") return; e.preventDefault();
          const text = eventTextEl.value;
          const { error } = await sb.from('events').upsert({ d: iso, text }, { onConflict: 'd' });
          if(error){ alert('保存失敗: '+error.message); return; }
          state.events[iso] = text; renderCalendar();
        }, {once:true});
      });
    }
    calendarEl.appendChild(cell);
  }
}

document.getElementById('btnPrevMonth').addEventListener('click', ()=>{ state.calMonth.m--; if(state.calMonth.m<0){ state.calMonth.m=11; state.calMonth.y--; } renderCalendar(); });
document.getElementById('btnNextMonth').addEventListener('click', ()=>{ state.calMonth.m++; if(state.calMonth.m>11){ state.calMonth.m=0; state.calMonth.y++; } renderCalendar(); });
document.getElementById('btnThisMonth').addEventListener('click', ()=>{ const t=new Date(); state.calMonth={y:t.getFullYear(), m:t.getMonth()}; renderCalendar(); });
document.getElementById('btnEventsHome').addEventListener('click', ()=> { state.currentUser=null; state.adminOverride=false; setView('home'); });
document.getElementById('btnArchiveHome').addEventListener('click', ()=> { state.currentUser=null; state.adminOverride=false; setView('home'); 
  
// ===== 履歴 =====
function openHistory(){ setView('history'); renderHistory(); }
async function renderHistory(){
  const list = document.getElementById('historyList');
  const { data, error } = await sb.from('bookings').select('d, slot, type, label, owner, created_at').order('created_at', {ascending:false}).limit(50);
  if(error){ list.innerHTML = `<div class="hint">読み込みエラー: ${escapeHTML(error.message)}</div>`; return; }
  const rows = data.map(r=>{
    const hour = 9 + r.slot; const range = `${hour}:00-${hour+1}:00`;
    const t = new Date(r.created_at).toLocaleString('ja-JP', { hour12:false });
    return `<div class="card" style="padding:10px; margin:8px 0">`+
      `<div><b>${escapeHTML(r.d)}</b> ${escapeHTML(range)} / ${escapeHTML(r.type)} / ${escapeHTML(r.label)} <span class="hint">by ${escapeHTML(r.owner)}</span></div>`+
      `<div class="hint">作成: ${escapeHTML(t)}</div>`+
    `</div>`;
  }).join('');
  list.innerHTML = rows || `<div class="hint">まだ履歴がありません。</div>`;
}
document.getElementById('btnHistoryHome').addEventListener('click', ()=> { state.currentUser=null; state.adminOverride=false; setView('home'); });

// ===== 過去予約（表示） =====
const archiveGrid = document.getElementById('archiveGrid');
function renderArchiveGrid(rows){
  // rows: [{d, data:[slot objects or null]}]
  // 14日を連番で並べる
  archiveGrid.innerHTML = '';
  const end = new Date(); end.setHours(0,0,0,0);
  const start = addDays(end, -13);
  const days = []; for(let i=0;i<14;i++){ days.push(addDays(start,i)); }

  // ヘッダ
  const head = document.createElement("div"); head.className = "header";
  const timeHead = document.createElement("div"); timeHead.textContent = "時間"; head.appendChild(timeHead);
  const map = new Map(rows.map(r=>[r.d, r]));
  days.forEach(d=>{
    const ds = dateToLocalISO(d);
    const mdColor = d.getDay()===0 ? '#ef4444' : (d.getDay()===6 ? '#3b82f6' : '#ffffff');
    const md = `${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]})`;
    const dv = document.createElement('div');
    dv.innerHTML = `<div><div style="font-size:12px;opacity:.95;color:${mdColor}">${md}</div><div style="font-size:10px;opacity:.7">${ds}</div></div>`;
    head.appendChild(dv);
  });
  archiveGrid.appendChild(head);

  // 9-21の12コマ
  for(let r=0; r<12; r++){
    const row = document.createElement("div"); row.className = "row-time";
    const tcell = document.createElement("div"); tcell.className = "timecell";
    const hour = 9 + r; tcell.textContent = `${hour}:00 - ${hour+1}:00`;
    row.appendChild(tcell);

    for(const d of days){
      const ds = dateToLocalISO(d);
      const snap = map.get(ds);
      const cell = document.createElement('div'); cell.className='cell';
      if(snap && Array.isArray(snap.data) && snap.data[r]){
        const s = snap.data[r];
        cell.style.background = s.color || "rgba(255,255,255,.08)";
        if(s.type==='band'){ cell.style.color='#000'; cell.style.textShadow='0 1px 1px rgba(255,255,255,.25)'; }
        cell.innerHTML = `<div class="badge">${escapeHTML(s.label)}</div>`;
      }
      row.appendChild(cell);
    }
    archiveGrid.appendChild(row);
  }
}

// ===== 初期化 =====
async function init(){
  setView("home");
  document.getElementById("home").hidden=false;
  initLimitOptions();
  // スナップショット監視開始
  startMidnightWatcher();
}
init();

// ===== グローバル関数束ね =====
window.addEventListener('visibilitychange', ()=>{
  // 22時跨ぎ時の補完に備え、復帰時にもチェック
  if(document.visibilityState==='visible'){ snapshotWatcherTick(); }
});
</script>
</body>
</html>
